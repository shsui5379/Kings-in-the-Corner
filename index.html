<!doctype html>
	<html>
		<head>
			<link href="https://fonts.googleapis.com/css?family=Press+Start+2P&display=swap" rel="stylesheet">
			<title>Kings in the Corner</title>
			<link rel="shortcut icon" type="image/png" href="cardimages/back-red-75-3.png"/>
			<style>
				/*general*/
				body, button, div {
					background-color: #ffbd38;
					font: 400 30px TW Cen MT;
					margin: 16px 0px;
					text-align: center;
				}
				h1 {
					text-align: center;
					font: 300 50pt "Press Start 2P";
				}

				/*scoreboard, buttons region*/
				#scoreboard, #instructionOpen, #reset {
					position: absolute;
					background-color: inherit;
				}
				#scoreboard {
					bottom: 1%;
					width: 100%;
				}
				#instructionOpen {
					left: 1%;
				}
				#reset {
					right: 1%;
				}

				/*buttons*/
				button {
					border-radius: 4px;
					height: 36px;
					padding: 0px 16px;
					margin: 8px 14px;
					outline: none;
				}
				button:hover {
					box-shadow: 0px 2px 4px -1px rgba(0,0,0,.2), 0px 4px 5px 0px rgba(0,0,0,.14), 0px 1px 10px 0px rgba(0,0,0,.12);
				}
				button:active {
					box-shadow: 0px 5px 5px -3px rgba(0,0,0,.2), 0px 8px 10px 1px rgba(0,0,0,.14), 0px 3px 14px 2px rgba(0,0,0,.12);
				}

				/*cards*/
				.blank {
					width: 75px;
					height: 108px;
					display: inline-block;
				}
				#center {
					position: relative;
					top: -296px;
					box-shadow: 2px 2px 0px 1px white;
				}

				/*instructions*/
				#instructionPopup {
					display: none;
					width: 76%;
					font-size: 15pt;
					position: absolute;
					top: 12%;
					left: 12%;
					z-index: 1;
					box-shadow: 0px 2px 1px -1px rgba(0,0,0,0.2), 0px 1px 1px 0px rgba(0,0,0,0.14), 0px 1px 3px 0px rgba(0,0,0,0.12);
					border-radius: 4px;
				}
				h6 {
					font-size: 25pt;
					margin: 20px 0px;
					font-weight: 500;
					text-decoration: underline;
				}
				ul {
					display: inline-block;
				}
				p {
					margin: 0px;
				}
				#instructionClose {
					margin: 20px;
				}

				#messageBoard {
					background-color: inherit;
				}
			</style>
			<script>
				//initializations and objects
				function initialize() {
					//attaching objects
					groups = [document.getElementsByClassName("side"), document.getElementsByClassName("top"), document.getElementsByClassName("corner")];
					for (var i = 0; i < groups.length; i++) { 
						for (var el of groups[i]) {
							el.src = "cardimages/target.png";
							el.space = new CardSpace(i+11); //represent each card space element from the front end as an object in the back end
							el.space.el = el; //path back to element
							el.onclick = function() {this.space.select();}
						}
					}

					//elements
					cardDeck = document.getElementById("center");
					instructionState = document.getElementById("instructionPopup");
					msgOut = document.getElementById("messageBoard");

					//deck
					var deck = new CardDeck() //an empty deck
					deck.populate(); //fill the deck
					deck.shuffle(); //shuffle the deck
					cardDeck.deck = deck; //attach to element
					cardDeck.deck.el = cardDeck; //path back to the element

					//states
					removalPhase = false;
					broadcaster = undefined;
					playerLost = false;
					currentPowerup = 0; //11: jump, 12: triple play, 13: card peek
					if (localStorage.earnedPowerup == undefined) {
						localStorage.earnedPowerup = 0; //apply next round
					}
				}


				//adding functions to HTMLCollections
				HTMLCollection.prototype.allOccupied = function() { //determine if all the CardSpaces in the group is occupied
					for (var el of this) {
						if (el.space.card == undefined) {
							return false;
						}
					}
					return true;
				}
				HTMLCollection.prototype.allRoyals = function() { //determines if there are 4 royals in that group
					if (this.allOccupied()) { //all spaces should be occupied first
						for (var el of this) {
							if (el.space.card.rank != el.space.groupNum) {
								return false;
							}
						}
						return true;
					}
					return false;
				}
				
				//CardSpace
				function CardSpace(loc) { //the individual card spaces 
					this.groupNum = loc; //11 is side, 12 is top/bottom, 13 is corner
				}
				CardSpace.prototype.select = function() { //onclick action of card spaces
					if (!playerLost) {
						msgClear();
						if (!removalPhase) { //if it's not the removal phase
							switch (true) {
								case broadcaster == undefined: //if a card hasn't been drawn
									msgOut.innerHTML = "Draw a card first";
									break;
								case this.card != undefined: //if there's already a card there
									msgOut.innerHTML = "This space is already occupied.";
									break;
								case validPlacement(this, broadcaster): //if the placement is valid, move card there
									this.card = broadcaster;
									this.el.src = broadcaster.imageSrc;
									cardDeck.src = "cardimages/back-red-75-3.png";
									broadcaster = undefined;
									if (localStorage.earnedPowerup == 0) { //determine if the player is elegible for a powerup (meaning hasn't earned one yet)
										awardPowerup();
									}
									if (proceedToRemovalPhase()) { //check if all spaces are occupied
										removalPhase = true;
										msgOut.innerHTML = "REMOVAL PHASE";
									}
									break;
								default: //if placement is invalid
									msgOut.innerHTML = "This card cannot go here.";
									break;
							}
						}
					}
				}

				//Card
				function Card(s, r) { //the individual cards
					this.rank = r;
					this.imageSrc = "cardimages/"+r+"-"+s+".png";
				}

				//CardDeck
				function CardDeck() {} //a deck of cards
				CardDeck.prototype = Array.prototype; //like an array
				CardDeck.prototype.populate = function() { //fills the deck with a standard deck
					for (var r=1; r!=14; r++) { //ranks
						for (var s=0; s!=4; s++) { //suits
							this.push(new Card(s, r));
						}
					}
				}
				CardDeck.prototype.shuffle = function() { //shuffling the deck of cards
					var temp = [];
					while (this.length != 0) {
						temp.push((this.splice(randomInteger(0, this.length-1), 1))[0]); //pull cards from random order into a temporary deck
					}
					this.push.apply(this, temp); //replace the actual deck with the new shuffled one
				}
				CardDeck.prototype.draw = function() { //drawing a card
					if (!playerLost) {
						msgClear();
						if (!removalPhase) { //can only draw a card when it's not removal phase
							if (broadcaster == undefined) { //can only draw a card if the previously drawn card has been placed down
								broadcaster = this.shift(); //broadcast what card has been drawn
								this.el.src = broadcaster.imageSrc; //display the card that has been drawn
								if (lost()) { //check if card is placable
									msgOut.innerHTML = "You lost.  Click reset to play again.  "
									playerLost = true;
								}
							} else {
								msgOut.innerHTML = "Place down the card before drawing the next one."
							}
						} else {
							msgOut.innerHTML = "You can't draw a card during the Removal Phase."
						}
					}
				}


				//tools
				function randomInteger(lower, upper) {  //random number generator
					var multiplier = upper - lower + 1;
					var rnd = Math.floor((Math.random() * multiplier) + lower);
					return rnd;
				}
				function validPlacement(space, card) { //determines if a card can go into a given space
					return !(card.rank > 10 && card.rank != space.groupNum);
				}
				function lost() { //determine if player has lose
					if (broadcaster.rank > 10) {
						return groups[broadcaster.rank-11].allOccupied(); //for royals, which placement is restricted, check if its possible group is full	
					}
					return false;
				}
				function proceedToRemovalPhase() { //check if all spaces are occupied
					for (var group of groups) {
						if (!group.allOccupied()) {
							return false;
						}
					}
					return true;
				}
				
				function awardPowerup() { //awards powerup based on 
					for (var group of groups) {
						if (group.allRoyals()) {
							localStorage.earnedPowerup = group[0].space.groupNum;
							switch (localStorage.earnedPowerup) {
								case "11":
									var name = "Jump";
									break;
								case "12":
									var name = "Triple Play";
									break;
								case "13":
									var name = "Card Peek";
									break;
							}
							msgOut.innerHTML = "You earned a powerup for your next round: " + name;
						}
					}
				}

				//controls
				function msgClear() { //clear error messages from message board
					if (removalPhase) {
						msgOut.innerHTML = "REMOVAL PHASE";
					} else {
						msgOut.innerHTML = "";
					}
				}
				function toggleInstructions() { //open or close instructions
					if (instructionState.style.display == "") { //open
						instructionState.style.display = "inline-block";
						document.body.style.backgroundColor = "#745619"; //dim background
					} else { //close
						instructionState.style.display = "";
						document.body.style.backgroundColor = "#ffbd38";
					}
				}
				function reset() { //reset round
					if(confirm("Are you sure you want to reset this round?  This cannot be undone.")) {

					}
				}
			</script>
		</head>
        <body onload="initialize();">
			<!-- top region -->
			<h1>Kings in the Corner</h1>
			<div id="messageBoard"></div>
			<br />

			<!-- board -->
			<span>
				<img class="corner" />
				<img class="top" />
				<img class="top" />
				<img class="corner" />
				<br />

				<img class="side" />
				<span class="blank"></span>
				<span class="blank"></span>
				<img class="side" />
				<br />

				<img class="side" />
				<span class="blank"></span>
				<span class="blank"></span>
				<img class="side" />
				<br />

				<img class="corner" />
				<img class="top" />
				<img class="top" />
				<img class="corner" />
				<br />

				<img id="center" src="cardimages/back-red-75-3.png" onclick="this.deck.draw();" />
			</span>

			<!-- instructions -->
			<div id="instructionPopup">
				<h6>Instructions</h6>
				<p>
					Start by clicking the deck in the center to draw a card.  Then, look at the card.  If it is a
					<ul>
						<li>Jack, it must be placed on a non-corner space on the left or right sides.</li>
						<li>Queen, it must be placed on a non-corner space on the top or bottom sides.</li>
						<li>King, it must be placed on a corner.</li>
						<li>number card, it can be placed anywhere.</li>
					</ul>
					<br />
					To place a card down, click on an appropriate empty card space.  If there are no appropriate card spaces free for you to put the card down on, you lost the game. 
					<br />
					Once you sucessfully filled all the spaces with appropriate cards, the game enters the removal phase.  
					<br />
					In this phase, click on any 2 number cards that sum to 10 to take them off the board.  A 10 card by itself can be clicked on to be removed.   An Ace is worth 1.  
					<br />
					Once all the number cards are taken off the board, you win the game.  If that's not possible, you lost the game.  
					<br /><br />
					You can earn points by
					<br />
					<ul>
						<li>placing a picture card down for 1 point.</li>
						<li>placing down 4 cards of the same royalty for 4 points.</li>
						<li>winning the game for 12 points + 1 point for each card left in the deck.</li>
					</ul>
					<br />
					You can earn a powerup once per round for your next round by
					<ul>
						<li>placing 4 kings for a card peek, which allows you one opportunity to peek at the next card in the deck.</li>
						<li>placing 4 queens for a triple play, which allows you one opportunity to remove 3 cards summing to 10 at once during removal phase.</li>
						<li>placing 4 jacks for a jump, which allows you to move a card that's already placed on the board (but must still be placed in an appropriate location).</li>
					</ul>
				</p>
				<button onclick="toggleInstructions()" id="instructionClose">Close</button>
			</div>

			<!-- scoreboard, button region -->
			<div id="scoreboard">
				<button id="instructionOpen" onclick="toggleInstructions();">Instructions</button>
				Current score: <span id="currentScore">0</span> High score: <span id="highScore">0</span>
				<button id="reset" onclick="reset();">Reset</button>
			<div>
		</body>
	</html>